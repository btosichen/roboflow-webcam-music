<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta charset="utf-8" />
    <title>Roboflow x Webcam éŸ³æ¨‚ç”Ÿæˆ</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <style>
      body { font-family: Arial, sans-serif; text-align: center; padding-top: 40px; }
      video { width: 320px; height: 240px; border: 1px solid #ccc; margin: 10px 0; }
      #status { font-weight: bold; margin-top: 10px; color: #333; }
    </style>
  </head>
  <body>
    <h1>ğŸ¹ Roboflow x Webcam éŸ³æ¨‚ç”Ÿæˆ</h1>
    <p>é»æ“Šä¸‹æ–¹æŒ‰éˆ•é–‹å§‹è¾¨è­˜èˆ‡ç”¢ç”ŸéŸ³æ¨‚ï¼</p>
    <video id="video" autoplay playsinline></video>
    <div id="status">ğŸ”„ æº–å‚™ä¸­...</div>
    <button id="startBtn">é–‹å§‹è¾¨è­˜èˆ‡æ¼”å¥</button>

    <script>
      const API_KEY = "rf_nlqrAIurThQGf734WeZgq6PRiuy1";
      const MODEL_ID = "my-first-project-ajfzb/1";
      const INTERVAL = 5000;
      const COUNT = 4;
      const notesMap = {
        "0": "C4", "1": "D4", "2": "E4", "3": "F4",
        "4": "G4", "5": "A4", "6": "B4", "7": "C5",
        "8": "D5", "9": "E5"
      };
      const video = document.getElementById("video");
      const statusDiv = document.getElementById("status");
      let recognitions = [];

      document.getElementById("startBtn").addEventListener("click", async () => {
        updateStatus("ğŸ“¸ å•Ÿå‹•æ”å½±æ©Ÿä¸­...");
        recognitions = [];
        await Tone.start();
        try {
          await startCamera();
          updateStatus("ğŸ” é–‹å§‹é€²è¡Œè¾¨è­˜...");
          for (let i = 0; i < COUNT; i++) {
            updateStatus(`â±ï¸ ç¬¬ ${i+1} æ¬¡è¾¨è­˜ä¸­...`);
            await new Promise(r => setTimeout(r, INTERVAL));
            const imgBlob = await captureImage();
            const result = await classifyImage(imgBlob);
            if (result) {
              recognitions.push(result);
              updateStatus(`âœ… ç¬¬ ${i+1} æ¬¡è¾¨è­˜å®Œæˆï¼š${result}`);
            } else {
              updateStatus(`âš ï¸ ç¬¬ ${i+1} æ¬¡è¾¨è­˜å¤±æ•—`);
            }
          }
          playMusic(recognitions);
        } catch (err) {
          updateStatus("âŒ ç™¼ç”ŸéŒ¯èª¤ï¼š" + err.message);
        }
      });

      function updateStatus(msg) {
        statusDiv.textContent = msg;
      }

      async function startCamera() {
        const stream = await navigator.mediaDevices.getUserMedia({ video: true });
        video.srcObject = stream;
        return new Promise(resolve => {
          video.onloadedmetadata = () => resolve();
        });
      }

      function captureImage() {
        return new Promise((resolve) => {
          const canvas = document.createElement("canvas");
          canvas.width = video.videoWidth;
          canvas.height = video.videoHeight;
          const ctx = canvas.getContext("2d");
          ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
          canvas.toBlob(resolve, "image/jpeg");
        });
      }

      async function classifyImage(blob) {
        const formData = new FormData();
        formData.append("image", blob);
        const url = `https://detect.roboflow.com/${MODEL_ID}?api_key=${API_KEY}`;
        const response = await fetch(url, { method: "POST", body: formData });
        const data = await response.json();
        return data.predictions && data.predictions.length > 0 ? data.predictions[0].class : null;
      }

      function playMusic(digits) {
        const synth = new Tone.Synth().toDestination();
        const now = Tone.now();
        digits.forEach((digit, i) => {
          const note = notesMap[digit] || "C4";
          synth.triggerAttackRelease(note, "8n", now + i * 0.5);
        });
        updateStatus("ğŸ¶ å·²æ’­æ”¾éŸ³æ¨‚ï¼ˆ" + digits.join(", ") + "ï¼‰");
      }
    </script>
  </body>
</html>
