<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta charset="utf-8" />
    <title>Roboflow x Webcam 音樂生成</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <style>
      body { font-family: Arial, sans-serif; text-align: center; padding-top: 40px; }
      video { width: 320px; height: 240px; border: 1px solid #ccc; margin: 10px 0; }
      #status { font-weight: bold; margin-top: 10px; color: #333; }
    </style>
  </head>
  <body>
    <h1>🎹 Roboflow x Webcam 音樂生成</h1>
    <p>點擊下方按鈕開始辨識與產生音樂！</p>
    <video id="video" autoplay playsinline></video>
    <div id="status">🔄 準備中...</div>
    <button id="startBtn">開始辨識與演奏</button>

    <script>
      const API_KEY = "rf_nlqrAIurThQGf734WeZgq6PRiuy1";
      const MODEL_ID = "my-first-project-ajfzb/1";
      const INTERVAL = 5000;
      const COUNT = 4;
      const notesMap = {
        "0": "C4", "1": "D4", "2": "E4", "3": "F4",
        "4": "G4", "5": "A4", "6": "B4", "7": "C5",
        "8": "D5", "9": "E5"
      };
      const video = document.getElementById("video");
      const statusDiv = document.getElementById("status");
      let recognitions = [];

      document.getElementById("startBtn").addEventListener("click", async () => {
        updateStatus("📸 啟動攝影機中...");
        recognitions = [];
        await Tone.start();
        try {
          await startCamera();
          updateStatus("🔍 開始進行辨識...");
          for (let i = 0; i < COUNT; i++) {
            updateStatus(`⏱️ 第 ${i+1} 次辨識中...`);
            await new Promise(r => setTimeout(r, INTERVAL));
            const imgBlob = await captureImage();
            const result = await classifyImage(imgBlob);
            if (result) {
              recognitions.push(result);
              updateStatus(`✅ 第 ${i+1} 次辨識完成：${result}`);
            } else {
              updateStatus(`⚠️ 第 ${i+1} 次辨識失敗`);
            }
          }
          playMusic(recognitions);
        } catch (err) {
          updateStatus("❌ 發生錯誤：" + err.message);
        }
      });

      function updateStatus(msg) {
        statusDiv.textContent = msg;
      }

      async function startCamera() {
        const stream = await navigator.mediaDevices.getUserMedia({ video: true });
        video.srcObject = stream;
        return new Promise(resolve => {
          video.onloadedmetadata = () => resolve();
        });
      }

      function captureImage() {
        return new Promise((resolve) => {
          const canvas = document.createElement("canvas");
          canvas.width = video.videoWidth;
          canvas.height = video.videoHeight;
          const ctx = canvas.getContext("2d");
          ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
          canvas.toBlob(resolve, "image/jpeg");
        });
      }

      async function classifyImage(blob) {
        const formData = new FormData();
        formData.append("image", blob);
        const url = `https://detect.roboflow.com/${MODEL_ID}?api_key=${API_KEY}`;
        const response = await fetch(url, { method: "POST", body: formData });
        const data = await response.json();
        return data.predictions && data.predictions.length > 0 ? data.predictions[0].class : null;
      }

      function playMusic(digits) {
        const synth = new Tone.Synth().toDestination();
        const now = Tone.now();
        digits.forEach((digit, i) => {
          const note = notesMap[digit] || "C4";
          synth.triggerAttackRelease(note, "8n", now + i * 0.5);
        });
        updateStatus("🎶 已播放音樂（" + digits.join(", ") + "）");
      }
    </script>
  </body>
</html>
