<!DOCTYPE html>
<html>
  <head>
    <title>Roboflow x Webcam 音樂生成</title>
    <meta charset="utf-8" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <style>
      body { font-family: Arial; text-align: center; padding-top: 50px; }
      video { width: 320px; height: 240px; border: 1px solid #ccc; margin-top: 10px; }
    </style>
  </head>
  <body>
    <h1>🎹 Roboflow x Webcam 音樂生成</h1>
    <video id="video" autoplay playsinline></video><br />
    <button id="startBtn">開始辨識與產生音樂</button>

    <script>
      const API_KEY = "rf_nlqrAIurThQGf734WeZgq6PRiuy1";
      const MODEL_ID = "my-first-project-ajfzb/1";
      const INTERVAL = 5000;
      const COUNT = 4;
      const notesMap = {
        "0": "C4", "1": "D4", "2": "E4", "3": "F4",
        "4": "G4", "5": "A4", "6": "B4", "7": "C5",
        "8": "D5", "9": "E5"
      };

      const video = document.getElementById("video");
      let recognitions = [];

      document.getElementById("startBtn").addEventListener("click", async () => {
        recognitions = [];
        await Tone.start();
        try {
          await startCamera();
          for (let i = 0; i < COUNT; i++) {
            await new Promise(r => setTimeout(r, INTERVAL));
            const imgBlob = await captureImage();
            const result = await classifyImage(imgBlob);
            if (result) recognitions.push(result);
          }
          playMusic(recognitions);
        } catch (err) {
          alert("錯誤：" + err.message);
        }
      });

      async function startCamera() {
        const stream = await navigator.mediaDevices.getUserMedia({ video: true });
        video.srcObject = stream;
        return new Promise(resolve => {
          video.onloadedmetadata = () => resolve();
        });
      }

      function captureImage() {
        return new Promise((resolve) => {
          const canvas = document.createElement("canvas");
          canvas.width = video.videoWidth;
          canvas.height = video.videoHeight;
          const ctx = canvas.getContext("2d");
          ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
          canvas.toBlob(resolve, "image/jpeg");
        });
      }

      async function classifyImage(blob) {
        const formData = new FormData();
        formData.append("image", blob);
        const url = `https://detect.roboflow.com/${MODEL_ID}?api_key=${API_KEY}`;
        const response = await fetch(url, { method: "POST", body: formData });
        const data = await response.json();
        if (data.predictions && data.predictions.length > 0) {
          return data.predictions[0].class;
        }
        return null;
      }

      function playMusic(digits) {
        const synth = new Tone.Synth().toDestination();
        const now = Tone.now();
        digits.forEach((digit, i) => {
          const note = notesMap[digit] || "C4";
          synth.triggerAttackRelease(note, "8n", now + i * 0.5);
        });
        alert("辨識結果：" + digits.join(", ") + " → 已轉換為音樂！");
      }
    </script>
  </body>
</html>
